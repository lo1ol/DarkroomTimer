[platformio]
default_envs=nanoatmega328

[env:nanoatmega328]
platform = atmelavr
framework = arduino
board = nanoatmega328
upload_speed = 115200
lib_deps =
    GyverLibs/EncButton @ ^3.7.0
    gyverlibs/GyverIO @ ^1.3.11
    bakercp/CRC32 @ ^2.0.0
build_flags =
    -Wno-switch
    -Werror
    -Wno-error=deprecated-declarations
    -DNDEBUG

# testing
test_framework = unity
platform_packages =
    platformio/tool-simavr
custom_mcu=atmega328p
test_speed = 9600
test_filter=parts/*
test_build_src=yes
# TODO add wrapper to remove timeout
test_testing_command =
    timeout
    --preserve-status
    -s
    INT
    30
    ${platformio.packages_dir}/tool-simavr/bin/simavr
    -m
    ${this.custom_mcu}
    -f
    16000000L
    ${platformio.build_dir}/${this.__env__}/firmware.elf

# mega has more memory then nano for testing scenarious
[env:scenarios-env]
extends=env:nanoatmega328
board = megaatmega2560
custom_mcu=atmega2560
test_filter=test_scenarios

[env:native]
platform = native
upload_speed = 115200
lib_deps =
    file://native_libs/FakeArduino/
lib_extra_dirs=native_libs
custom_extra_build_flags=
build_flags =
    -Wno-switch
    -Werror
    -std=c++17
    -DDT_NATIVE
    -g
    -O0
    ${this.custom_extra_build_flags}
test_build_src=yes
test_ignore=parts/test_settings

[env:native-valgrind]
extends=env:native
extra_scripts = ./scripts/test_valgrind.py

[env:native-cov]
extends=env:native
custom_extra_build_flags =
    --coverage
    -lgcov
