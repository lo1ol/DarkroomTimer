# Продвинутое реле времени. KAF Красный луч RR-1

> Этот проект вдохновлен [прошлой версией похожего реле](https://github.com/nikonov1101/kafstop-timer), но улучшает и расширяет его возможности

> [3D модель корпуса](https://www.thingiverse.com/thing:6683466)

> [Youtube плейслист с инструкцией по сборке](https://www.youtube.com/watch?v=XjmDx0XmCiA&list=PLLB8YXu4D8PvZlZFQPj_stn8mG01y7iiN&pp=gAQB)

> **Основная идея:** Вы подготавливаете все на свету, чтобы во время печати нажимать только на кнопку старта

> [Онлайн симулятор](https://wokwi.com/projects/438577058575190017). Заметьте, что в эмуляторе устройством удобнее управлять через клавиатуру

## Инструкция

1. Кликни кнопку просмотра, чтобы включить/выключить лампу
2. Удерживай кнопку режима и крути энкодер, чтобы переключаться между режимами
3. Кликни кнопку режима, чтобы перемещаться внутри режима
4. Удерживай кнопку на энкодере, чтобы сбросить печать в любом режиме (во время установок масок вы можете зажать и крутить энкодер, чтобы быстро перемещаться между масками)
5. Крути энкодер во время показа таблицы времени, чтобы перемещаться внутри нее
6. Кликни кнопку старта, чтобы начать печать в любом режиме
7. Удерживай нопку просмотра и переключения режима, чтобы войти в режим настроек

## Настройки

1. Лаг запуска лампы
2. Яркость подсветки
3. Громкость пищалки
4. Время автоотключения лампы в режиме просмотра
5. Возможность стартовать с настроек

## Режимы

1. Тест F стопами: позволяет произвести быстрый тест для подбора тона изображения повышая каждый следующий тест на заданный тон. Размер тона можно уменьшать.
2. Линейный тест: Задается начальное значение и шаг
3. Режим печати: можете задать время и печатать с ним. Дополнительно есть возможность остановки печати и печати по удержанию кнопки (удобно для маскирования и коротких выдержках).
4. Режим маскирования: задайте количество масок и время, которое нужено для засветки определенной маски. Нажмите кнопку на энкодере во время установки масок, чтобы перейти к следующей маске. Удерживайте кнопку на энкодере и крутите энкодер, чтобы бысто перемещаться во время устанки масок. Нажмите на кнопку старта, во время установки масок, чтобы поставить напоминание на конкретной маске. После печати маски с уведомлением проиграет милодия, которая напомнит вам сделать что-то, например, сменить фильтр
5. Режим относительного маскирования: аналогичен обычному маскированию, но времена задаются относительно: указывается базовое время и в масках указывается количество стопов относительно него. Уведомления не работают. Для того, чтобы увидеть реальные времена, нажмите на encoder во время печати
6. Сплит грейд тесты: аналогичны тестам F стопами и линейным тестам, но с возможностью выставить начальное время экспонирования (время засветки первым фильтром). После печати базового времени играет мелодия, чтобы вы не забыли сменить фильтр
7. Сплит режимы маскирования и относительного маскирования: аналогичены обычным, но маски можно задавать для двух фильтров (0 и 5). Уведомления не работают
8. Локализованные тестовые режимы: аналогичны тестам F стопами и линейным тестам, но используемые для печати одинаково сегмента. Время которое сейчас показывается -- полное время печати теста. [3D модель инструмента, чтобы делать полоски можно найти здесь](https://www.thingiverse.com/thing:7048981)

## Killer фичи:

1. Есть возможность останоить любую печать. Это может быть удобно, если вы обнаружили, что забыли убрать красный фильтр
2. Есть возможность задать лаг запуска лампы. Некоторые фотоувеличители запускают лампу не сразу, а с некоророй задержкой. Чтобы компенсировать это значение, задайте лаг старта. Это значение будет отсчитываться перед любым запуском таймера и не будет учитываться. Чтобы определить задержку, перейдите в настройки и установите значение на глаз. Нажмите на кнопку старт, чтобы проверить его. Если за это время лампа не включилась, увеличьте это значение, иначе попробуйте уменьшить.
3. Пищилка, которая срабатывает раз в 1 секунду. Удобно для быстрого маскирования.
4. Возможность выставлять время автоотключения лампы при просмотре. Это увеличит срок службы лампы в вашем фотоувеличителе
5. Возможность отключения подсветки дисплея. Удобно для цветной печати
6. Простая архитектура проекта, которая позволит вам с легкостью добавить новые настройки и режимы по необходимости

## Сборка

### Схема

#### Основная часть

> Note: часть выделенная пунктиром -- это блок питания. Его подробная схема представлена ниже

![Схема основной части](./MainBodyCircuit.jpg)

#### Блок Питания

![Схема блока питания](./PowerSupplyCircuit.jpg)

### Корпус

Мой товарищь сделал самый крутой корпус, который вы только сможете представить!!! Вы можете найти его [здесь](https://www.thingiverse.com/thing:6683466)

#### Компоненты

1. [Энкодер](https://sl.aliexpress.ru/p?key=d3DhGvG)
2. [Кнопки](https://sl.aliexpress.ru/p?key=SoBfsmF)
3. [LED](https://sl.aliexpress.ru/p?key=tgDHsiN)
4. [Пассивный зумер](https://sl.aliexpress.ru/p?key=iXIeG78)
5. [Переключатель](https://sl.aliexpress.ru/p?key=f3PfsRC)
6. [Трансформатор на 5V](https://sl.aliexpress.ru/p?key=5RdhGtS) (Не проверен полноценно). Также  вы можете просто разобрать любую 5В USB зарядку для телефона
7. [Arduino nano](https://sl.aliexpress.ru/p?key=daDhGj5): советую взять именно версию с процессором ATmega 328P. Версии с ATmega 168 могут иметь недостаточно памяти, для прошивки. Обратите внимание, что нужна ардуино с разъемом mini usb
8. Используется всего один резистор для установки контраста дисплея: 2.2 кОм. Ваше значение может отличаться от моих.
9. Также вы можете купить педаль сустейна для и подключать ее через Jack гнездо. Это будет очень удобно при маскировании. Педаль должна быть нормально-открытой или иметь переключатель полярности. Мы используем педаль "Cherub wtb-006"
10. [Jack 6.35](https://sl.aliexpress.ru/p?key=W4aeGRp)
11. Твердотельное реле 5V:
    * Если вам нужна работа с любыми лампами (LED, галогенные):
        - [D3803HK/D3805HK/D3808HK](https://sl.aliexpress.ru/p?key=xlW6GV3)
        - [BERM BRM-D480-5A](https://sl.aliexpress.ru/p?key=KyW6GRj)
        - [SSR-41FDA](https://sl.aliexpress.ru/p?key=oBW6G3x)
        - [RUICHI SSR G7DA-48(Z)D3](https://ozon.ru/t/3Wmz3qN). Есть еще версия на на 240V, но я ее не проверял
    * Если вам не нужна работа с маломощными лампами (LED), можете взять [эту](https://sl.aliexpress.ru/p?key=wXDhGqU). Это реле пропускает небольшой ток в закрытом состоянии и маломощные лампы будут просвечивать

> **WARNING**: не используйте в качестве замены SSR электромагнитные реле. Они создают помехи в цепи, которые приводят к странным символам на экране и могут вывести ардуино из строя

В корпусе нет места для реле и трансформатора. Их лучше вынести в отдельный специальный корпус для РЭА и подключать, например, по XLR. Так будет безопаснее и корпус из-за этого выглядит лучше:)

Дополнительные детали для корпуса:
1. [XLR](https://sl.aliexpress.ru/p?key=bFaeGJn) -- используется, чтобы соедитить основную часть с блоком питания
2. [Акриловое черное стекло](https://sl.aliexpress.ru/p?key=tvaeGQb) -- чтобы закрыть дисплей
3. [Разетки для блока питания](https://sl.aliexpress.ru/p?key=xoaeGXb)
4. [Переключатель для блока питания](https://sl.aliexpress.ru/p?key=moaeG8T)
5. [Винты M2](https://sl.aliexpress.ru/p?key=rRaeGCg)
6. Винты и гайки M3. Можете купить где угодно
7. [Трехжильный сетевой шнур 0.75 со штепселем на блок питания](https://www.chipdip.kz/product0/494606311) или [такой (не проверен)](https://sl.aliexpress.ru/p?key=Y0zn3DN)
8. [Монтыжные провода 0.2 для распайки электроники](https://www.chipdip.kz/product/amp30-mgshv-0.2) или [такие (не проверены)](https://sl.aliexpress.ru/p?key=lsNn3rZ)
9. [Термоусадочная трубка 2 метра](https://www.chipdip.kz/product/iske-h-3x-4.5-1.5-black) или [такая (не проверена)](https://sl.aliexpress.ru/p?key=ChNn3Wr)
10. [Двусторонний полупрозрачный скотч](https://sl.aliexpress.ru/p?key=pbNn3xt)

### Другие версии корпуса

Я видел другие версии корпуса, которые собраны из ящика для электрокомпонентов и используют легкодоступные кнопки и переключатели. Вы можете собирать свои версии корпуса исходя из своего бюджета

## Сценарий использования

Интерфейс реле устроен таким образом, чтобы соответствовать вашему воркфлоу. Я предлагаю его использовать так:
1. Сначала в режиме тестов F стопами подобрать грубое время печати
2. Далее подобрать более точное время линейными тестами (или снова через тест F стопами с небольшим значением шага, например 1/4)
3. После этого напечатать изображение целиком в режиме печати
4. В следующий раз в этом же режиме попробовать грубо замаскировать изображение и получить примерное значение масок
5. В следующий раз напечатать это же изображения в режиме маскирования зная точные значения масок

### Пример:

1. Печатаю изображение f стопами: выставляю начальное значние 2, шаг 1 и делаю 6 тестов (2, 4, 8, 16, 32, 64). Увидел, что желаемое изображение находится в пределах 16 и 32
2. Подбор более точно значения печати:
  - Тест f стопами: Печатаю изображение снова f стопами, но на этот раз взяв шаг 1/4. делаю 5 тестов. Увидел, что значение на 4ом тесте меня устраивает. Смотрю лог печати: 16, 19, 23, 27, 32. Мне нравится 4ый тест, значит искомое значение 27
  - Линейный тест: Делаю 5 тестов от 16 до 32: 16, 20, 24, 28, 32. Нам понравилось 4ое значение: 28
3. Делаем полную печать в режиме печати со значение 28
4. Увидели, что есть некоторые участки, которые хотелось бы пересветить на 3 секунды и недосветить на 8 секунд. Для этого, выставляю в режиме печати 31 секунду. Маскирую часть, которую нужно пересветить на 3 секунды. Запускаю реле и отсчитываю 3 секунды (через писки). Останвиваюсь, затем маскирую часть, которую нужно замаскировтаь на 8 секунд. Запускаю реле и отсчитываю 8 секунд. Останавливаюсь, убираю маски и засвечиваю оставшуюся части изображения как есть
5. Если хочу получить повторяемый результат и сделать несколько похожих отпечатков, перехожу в режим маскирования. Выставляю маски, 3, 8, 20 и повторяю ту же самую процедуру. Таймер будет останавливаться после засветки каждой из масок

## Сборка и загрузка прошивки на Arduino

Если вы хотите просто собрать прошивку и залить ее без изменений, то самый простой способ сделать это -- использовать Arduino IDE
3. Поставте Arduino IDE
1. Склонируйе этот git проект в любую из директорий
2. Откройте ino файл через Arduino IDE (`File`->`Open...`->`path to .ino` file)
4. Установите зависимости проекта (`Tools` -> `Manage Libraries...`):
   * EncButton
   * LiquidCrystals
   * CRC32 (by Crystopher Baker)
5. Выберете board -- Arduino Nano и processor --  ATmega328P
6. Нажмите на кнопку Upload

Если вы хотите модифицировать код, то я советую работать с проектом через PlatfromIO

```bash
# build from command line
cd DarkroomTimer/
pio run -t build

# upload to device
pio run -t upload
```

### Конфигурирование прошивки

Вы можете сконфигурировать прошивку под ваши нужды. Для этого вам нужно изменить значения макросов в файле [Config.h](DarkroomTimer/src/lib/DarkroomTimer/Config.h):
* `LCD_*` -- пин до `*` пина на дисплее
* `MODE_BTN` -- пин до кнопки смены режима
* `VIEW_BTN` -- пин до кнопки просмотра
* `START_BTN` -- пин до кнопки старта
* `ENCODER_BTN` -- пин до кнопки на энкодере
* `ENCODER_DT` -- пин до пина DT(S1) на энкодере (МЕНЯТЬ НЕ РЕКОМЕНДУЕТСЯ)
* `ENCODER_CLK` -- пин до пина CLK(S2) на энкодере (МЕНЯТЬ НЕ РЕКОМЕНДУЕТСЯ)
* `BEEPER` -- пин до зумера (МЕНЯТЬ НЕ РЕКОМЕНДУЕТСЯ)
* `BACKLIGHT` -- пин до пина регулировки подсветки на дисплее (помечен как `A` на дисплее)
* `RELAY` -- пин до твердотельного реле
* `MAX_BACKLIGHT` -- максимальное значение яркости (максимальное значение 25)
* `MIN_BEEP_VOLUME` -- минимальный уровень громкости. Может отличаться на разных зуммерах
* `BEEP_VOLUME_STEP` -- шаг громкости зуммера
* `ENCODER_FAST_TIMEOUT` -- время вращения энкодера, до которого вы будете менять значения быстрее
* `ENCODER_FAST_FAST_TIMEOUT` --  время вращения энкодера, до которого вы будете менять значения еще быстрее

> NB: смена пина ENCODER_DT на ENCODER_CLK меняет направление энкодера

## Поддержка

Если есть вопросы, проблемы и предложения, то можете писать нам:)

Богдан (дизайн, 3D печать):<br>
tg: [@bogdanbogvzyan](http://t.me/bogdanbogvzyan)<br>
email: [panasyukbv@yandex.ru](mailto:panasyukbv@yandex.ru?subject=Darkroom%20timer)

Петя (код, сборка):<br>
tg: [@lo1ol](http://t.me/lo1ol)<br>
email: [myprettycapybara@gmail.com](mailto:myprettycapybara@gmail.com?subject=Darkroom%20timer)
