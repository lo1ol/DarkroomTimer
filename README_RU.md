# Удобное реле времени со множеством фишек

## Этот проект вдохновлен [прошлой версией похожего реле](https://github.com/nikonov1101/kafstop-timer), но улучшает и расширяет его возможности

## Инструкция

1. Кликни кнопку просмотра, чтобы включить/выключить лампу
2. Удерживай кнопку режима и крути энкодер, чтобы переключить режим
3. Кликни кнопку режима, чтобы перемещаться внутри режима
4. Кликни кнопку на энкодере, когда таймер не готов к печати, чтобы посмотреть лог
5. Кликни кнопку на энкодере, когда таймер готов к печати, чтобы переключить режим просмотра (Во время установки масок вы тоже можете переключить режим просмотра)
6. Удерживай кнопку на энкодере, чтобы сбросить печать в любом режиме (во время установок масок вы так можете перейти на первую маску)
7. Кликни кнопку старта, чтобы начать печать в любом режиме
8. Удерживай нопку просмотра и переключения режима, чтобы войти в режим настроек

## Настройки

1. Лаг запуска лампы
2. Яркость подсветки
3. Громкость пищалки
4. Время автоотключения лампы в режиме просмотра
5. Возможность стартовать с настроек
6. Дефолтный вид в тестовых режимах и режиме маскирования (обычный вид/вид через лог)

## Режими

1. Тест F стопами: позволяет произвести быстрый тест для подбора тона изображения повышая каждый следующий тест на заданный тон. Размер тона можно уменьшать. После печати вы можете посмотреть лог печати
2. Линейный тест: Задается начальное значение и шаг
3. Режим печати: можете задать время и печатать с ним. Дополнительно есть возможность остановки печати и печати по удержанию кнопки (удобно для маскирования и коротких выдержках).
4. Режим маскирования: задайте количество масок и время, которое нужено для засветки определенной маски

## Killer фичи:

1. Есть возможность останоить любую печать. Это может быть удобно, если вы обнаружили, что забыли убрать красный фильтр
2. Есть возможность задать лаг запуска лампы. Некоторые фотоувеличители запускают лампу не сразу, а с некоророй задержкой. Чтобы компенсировать это значение, задайте лаг старта. Это значение будет отсчитываться перед любым запуском таймера и не будет учитываться. Чтобы определить задержку, перейдите в настройки и установите значение на глаз. Нажмите на кнопку старт, чтобы проверить его. Если за это время лампа не включилась, увеличьте это значение, иначе попробуйте уменьшить.
3. Пищилка, которая срабатывает раз в 1 секунду. Удобно для быстрого маскирования.
4. Возможность выставлять время автоотключения лампы при просмотре. Это увеличит срок службы лампы в вашем фотоувеличителе
5. Возможность отключения подсветки дисплея. Удобно для цветной печати
6. Простая архитектура проекта, которая позволит вам с легкостью добавить новые настройки и режимы по необходимости

## Сборка

### Схема

![Схема](./Circuit.jpg)

### Крутой корпус

Мой товарищь сделал самый крутой корпус, который вы только сможете представить!!! Вы можете найти его [здесь](https://www.thingiverse.com/thing:6683466)

#### Компоненты

1. [Энкодер EC11](https://sl.aliexpress.ru/p?key=1wDHs4W)
2. [Кнопки](https://sl.aliexpress.ru/p?key=SoBfsmF)
3. [LED](https://sl.aliexpress.ru/p?key=tgDHsiN)
4. [Пассивный зумер](https://sl.aliexpress.ru/p?key=XcDHsAE)
5. [Твердотельное реле 5V](https://sl.aliexpress.ru/p?key=AWDHsN6)
6. [Переключатель](https://sl.aliexpress.ru/p?key=f3PfsRC)
7. Трансформатор на 5V -- вы можете просто разобрать любую USB зарядку для телефона (5V, 2.4A должно быть достаточно)
8. Arduino nano: советую взять именно версию с процессором ATmega 328P. Версии с ATmega 168 могут иметь недостаточно памяти, для прошивки.
9. Конденсатор. Нужен для устранения утечек из твердотельного реле. Я использовал метало-пленочный конденсатор емкостью 1 мкФ для 250V. Его можно не ставить, если вы не планируете использовать реле с маломощными лампами
10. Используется всего два резистора. Первый для установки яркости подсветки (160 Ом) и второй для установки констраста дисплея (2.2 кОм). Ваши значения могут отличаться от моих.
11. Также советвую купить любую педаль сустейня для и подключать ее через Jack гнездо. Это будет очень удобно при маскировании. Я купил дешевую "Cherub wtb-006" и не жалуюсь

В этом корпусе нет места для конденсатора, реле и трансформатора. Их лучше вынести в отдельный специальный корпус для РЭА и подключать, например, по XLR. Так будет безопаснее и корпус из-за этого выглядит лучше:)

### Простой корпус

[3D модель корпуса](./TimerBox.stl)

#### Компоненты

Все то же самое, что и для крутой модели, кроме кнопок, переключателей и пружинок

1. [Кнопки 12x12](https://sl.aliexpress.ru/p?key=8sDHsMU)
2. [Кнопки 6x6](https://sl.aliexpress.ru/p?key=TiDHsci)
3. [Переключатель](https://sl.aliexpress.ru/p?key=7LDHstq)
4. Пружинки для кнопки старта можно достать из шариковых ручек

Также в этом корпусе достаточно места, чтобы засунуть конденсатор, реле и трансформатор прям туда. Но я все еще советую положить их в отдельный безопасный короб для РЭА.

## Сценарий использования

Интерфейс реле устроен таким образом, чтобы соответствовать вашему воркфлоу. Я предлагаю его использовать так:
1. Сначала в режиме тестов F стопами подобрать грубое время печати
2. Далее подобрать более точное время линейными тестами (или снова через тест F стопами с небольшим значением шага, например 1/4)
3. После этого напечатать изображение целиком в режиме печати
4. В следующий раз в этом же режиме попробовать грубо замаскировать изображение и получить примерное значение масок
5. В следующий раз напечатать это же изображения в режиме маскирования зная точные значения масок

### Пример:

1. Печатаю изображение f стопами: выставляю начальное значние 2, шаг 1 и делаю 6 тестов (2, 4, 8, 16, 32, 64). Увидел, что желаемое изображение находится в пределах 16 и 32
2. Подбор более точно значения печати:
  - Тест f стопами: Печатаю изображение снова f стопами, но на этот раз взяв шаг 1/4. делаю 5 тестов. Увидел, что значение на 4ом тесте меня устраивает. Смотрю лог печати: 16, 19, 23, 27, 32. Мне нравится 4ый тест, значит искомое значение 27
  - Линейный тест: Делаю 5 тестов от 16 до 32: 16, 20, 24, 28, 32. Нам понравилось 4ое значение: 28
3. Делаем полную печать в режиме печати со значение 28
4. Увидели, что есть некоторые участки, которые хотелось бы пересветить на 3 секунды и недосветить на 8 секунд. Для этого, выставляю в режиме печати 31 секунду. Маскирую часть, которую нужно пересветить на 3 секунды. Запускаю реле и отсчитываю 3 секунды (через писки). Останвиваюсь, затем маскирую часть, которую нужно замаскировтаь на 8 секунд. Запускаю реле и отсчитываю 8 секунд. Останавливаюсь, убираю маски и засвечиваю оставшуюся части изображения как есть
5. Если хочу получить повторяемый результат и сделать несколько похожих отпечатков, перехожу в режим маскирования. Выставляю маски, 3, 8, 20 и повторяю ту же самую процедуру. Таймер будет останавливаться после засветки каждой из масок

## Сборка и загрузка прошивки на Arduino

Если вы хотите просто собрать прошивку и залить ее без изменений, то самый простой способ сделать это -- использовать Arduino IDE
1. Просто поставте Arduino IDE
2. Установите зависимости проекта: EncButton, LiquidCrystals и CRC32
3. Склонируйе этот git проект в любую из диреткорий
4. Откройте его через Arduino IDE
5. Выберете board -- Arduino Nano и processor --  ATmega328P
6. Нажмите на кнопку Upload

Если вы хотите модифицировать код, то я советую работать с проектом через PlatfromIO

```bash
# build from command line
pio run -t build

# upload to device
pio run -t upload
```
